name: Update IPTV Playlists

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - 'update_playlists.py'
      - '.github/workflows/update_playlists.yml'

jobs:
  update-playlists:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml requests schedule
    
    - name: Create Python script
      run: |
        cat > update_playlists.py << 'EOF'
#!/usr/bin/env python3
"""
Auto-update IPTV playlists for GitHub Actions
"""

import yaml
import json
import time
import requests
import re
import os
import sys
from datetime import datetime
from pathlib import Path

print("üöÄ Starting IPTV Playlist Auto-Updater on GitHub Actions...")

# Create output directory
output_dir = Path("auto_updated_playlists")
output_dir.mkdir(exist_ok=True)

# Define playlist sources
PLAYLIST_SOURCES = {
    "all_channels": "https://raw.githubusercontent.com/abusaeeidx/Mrgify-BDIX-IPTV/main/playlist.m3u"
}

def fetch_playlist(url):
    """Fetch a playlist from URL"""
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        response = requests.get(url, headers=headers, timeout=30)
        response.raise_for_status()
        return response.text
    except Exception as e:
        print(f"‚ùå Error fetching {url}: {e}")
        return None

def parse_m3u(content, source_name=""):
    """Parse M3U content"""
    channels = []
    if not content:
        return channels
    
    lines = content.split('\n')
    for i in range(len(lines)):
        line = lines[i].strip()
        if line.startswith('#EXTINF:'):
            info = {'source': source_name}
            
            # Extract info
            logo_match = re.search(r'tvg-logo="([^"]*)"', line)
            info['logo'] = logo_match.group(1) if logo_match else ''
            
            group_match = re.search(r'group-title="([^"]*)"', line)
            info['group'] = group_match.group(1) if group_match else 'General'
            
            parts = line.split(',')
            info['name'] = parts[-1] if len(parts) > 1 else 'Unknown'
            
            # Get URL
            j = i + 1
            while j < len(lines) and (not lines[j].strip() or lines[j].startswith('#')):
                j += 1
            
            if j < len(lines) and lines[j].strip():
                url = lines[j].strip()
                if url and url.startswith(('http://', 'https://')):
                    info['url'] = url
                    channels.append(info)
    
    return channels

def update_playlist():
    """Perform a single update"""
    print(f"\nüìÖ Starting update: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} UTC")
    
    all_channels = []
    seen_urls = set()
    
    for name, url in PLAYLIST_SOURCES.items():
        print(f"üì• Fetching {name}...")
        content = fetch_playlist(url)
        if content:
            channels = parse_m3u(content, name)
            for channel in channels:
                if channel['url'] not in seen_urls:
                    seen_urls.add(channel['url'])
                    all_channels.append(channel)
            print(f"   ‚úÖ Found {len(channels)} channels")
        else:
            print(f"   ‚ùå Failed to fetch")
    
    if not all_channels:
        print("‚ùå No channels fetched!")
        return False
    
    # Prepare YAML data
    current_time = datetime.now()
    yaml_data = {
        'metadata': {
            'title': 'IPTV Playlists - Auto Updated',
            'description': f'Auto-updated playlist via GitHub Actions. Last update: {current_time.strftime("%Y-%m-%d %H:%M:%S")} UTC',
            'total_channels': len(all_channels),
            'generated_at': current_time.isoformat(),
            'update_frequency': '5 minutes',
            'generated_by': 'GitHub Actions',
            'repository': '${{ github.repository }}'
        },
        'sources': list(PLAYLIST_SOURCES.values()),
        'channels': [],
        'statistics': {
            'total': len(all_channels),
            'by_source': {},
            'by_category': {}
        }
    }
    
    # Calculate statistics
    for channel in all_channels:
        source = channel.get('source', 'unknown')
        category = channel.get('group', 'General')
        
        yaml_data['statistics']['by_source'][source] = yaml_data['statistics']['by_source'].get(source, 0) + 1
        yaml_data['statistics']['by_category'][category] = yaml_data['statistics']['by_category'].get(category, 0) + 1
    
    # Add channels (limit to 100 for file size)
    for i, channel in enumerate(all_channels[:100]):
        yaml_data['channels'].append({
            'id': i + 1,
            'name': channel.get('name', ''),
            'category': channel.get('group', 'General'),
            'logo': channel.get('logo', ''),
            'url': channel.get('url', ''),
            'source': channel.get('source', '')
        })
    
    if len(all_channels) > 100:
        yaml_data['channels'].append({
            'note': f'... and {len(all_channels) - 100} more channels'
        })
    
    # Save files
    timestamp = current_time.strftime("%Y%m%d_%H%M%S")
    
    # Save YAML
    yaml_file = output_dir / f"playlist_{timestamp}.yml"
    with open(yaml_file, 'w', encoding='utf-8') as f:
        f.write("# Auto-Updated IPTV Playlist\n")
        f.write("# Updated every 5 minutes via GitHub Actions\n")
        f.write(f"# Repository: https://github.com/${{ github.repository }}\n")
        f.write(f"# Last update: {current_time.strftime('%Y-%m-%d %H:%M:%S')} UTC\n\n")
        yaml.dump(yaml_data, f, default_flow_style=False, allow_unicode=True, sort_keys=False)
    
    # Save as latest.yml
    latest_file = output_dir / "latest.yml"
    with open(latest_file, 'w', encoding='utf-8') as f:
        yaml.dump(yaml_data, f, default_flow_style=False, allow_unicode=True, sort_keys=False)
    
    # Save JSON version
    json_file = output_dir / f"playlist_{timestamp}.json"
    with open(json_file, 'w', encoding='utf-8') as f:
        json.dump(yaml_data, f, indent=2, ensure_ascii=False)
    
    # Create summary file
    summary_file = output_dir / "README.md"
    with open(summary_file, 'w', encoding='utf-8') as f:
        f.write(f"""# Auto-Updated IPTV Playlists

## üìä Latest Update
- **Last Updated:** {current_time.strftime('%Y-%m-%d %H:%M:%S UTC')}
- **Total Channels:** {len(all_channels)}
- **Update Frequency:** Every 5 minutes
- **Generated By:** GitHub Actions

## üìÅ Available Files
- `latest.yml` - Always contains the latest playlist
- `playlist_{timestamp}.yml` - Timestamped version
- `playlist_{timestamp}.json` - JSON version

## üìä Statistics
### By Source:
""")
        for source, count in sorted(yaml_data['statistics']['by_source'].items(), key=lambda x: x[1], reverse=True):
            f.write(f"- {source}: {count} channels\n")
        
        f.write("\n### Top Categories:\n")
        categories_sorted = sorted(yaml_data['statistics']['by_category'].items(), key=lambda x: x[1], reverse=True)[:10]
        for category, count in categories_sorted:
            f.write(f"- {category}: {count} channels\n")
        
        f.write(f"""
## üîó Usage
These playlists can be used with any IPTV player that supports M3U/YAML format.

## ‚öôÔ∏è Automation
This playlist is automatically updated every 5 minutes using GitHub Actions.
See [.github/workflows/update_playlists.yml](/.github/workflows/update_playlists.yml) for details.

---
*Last auto-generated: {current_time.strftime('%Y-%m-%d %H:%M:%S UTC')}*
""")
    
    print(f"\n‚úÖ Update completed!")
    print(f"   üìä Total channels: {len(all_channels)}")
    print(f"   üíæ Files saved:")
    print(f"     - {yaml_file}")
    print(f"     - {latest_file}")
    print(f"     - {json_file}")
    print(f"     - {summary_file}")
    
    return True, len(all_channels)

if __name__ == "__main__":
    success, channel_count = update_playlist()
    if success:
        # Output channel count for GitHub Actions summary
        print(f"::set-output name=channel_count::{channel_count}")
        print(f"::set-output name=timestamp::{datetime.now().strftime('%Y%m%d_%H%M%S')}")
    sys.exit(0 if success else 1)
EOF
        
        chmod +x update_playlists.py
    
    - name: Run playlist updater
      id: update
      run: |
        python update_playlists.py
      continue-on-error: true
    
    - name: Create GitHub Pages index
      if: steps.update.outcome == 'success'
      run: |
        mkdir -p docs
        cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Updated IPTV Playlists</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
               line-height: 1.6; color: #333; max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 40px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                 color: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 10px; font-size: 2.5em; }
        .status { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status h2 { color: #667eea; margin-bottom: 15px; }
        .files { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .file-card { background: white; border: 1px solid #e1e4e8; border-radius: 8px; padding: 20px; transition: all 0.3s; }
        .file-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-color: #667eea; }
        .file-card h3 { color: #24292e; margin-bottom: 10px; }
        .file-card p { color: #586069; margin-bottom: 15px; }
        .btn { display: inline-block; padding: 10px 20px; background: #2ea44f; color: white; text-decoration: none; 
               border-radius: 6px; font-weight: 600; transition: background 0.3s; }
        .btn:hover { background: #2c974b; }
        .stats { background: #f6f8fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        footer { margin-top: 40px; text-align: center; padding: 20px; color: #6a737d; border-top: 1px solid #e1e4e8; }
        .badge { display: inline-block; padding: 4px 8px; background: #2ea44f; color: white; border-radius: 4px; 
                 font-size: 0.8em; font-weight: 600; margin-left: 10px; }
        @media (max-width: 768px) { .files { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <h1>üì∫ Auto-Updated IPTV Playlists</h1>
        <p>Updated every 5 minutes via GitHub Actions</p>
    </header>
    
    <section class="status">
        <h2>üìà Current Status</h2>
        <p><strong>Last Update:</strong> <span id="last-update">Loading...</span></p>
        <p><strong>Total Channels:</strong> <span id="total-channels">Loading...</span></p>
        <p><strong>Update Frequency:</strong> Every 5 minutes</p>
        <p><strong>Next Update:</strong> <span id="next-update">Loading...</span></p>
    </section>
    
    <section>
        <h2>üìÅ Available Playlists</h2>
        <div class="files" id="files-list">
            <!-- Files will be loaded dynamically -->
            <p>Loading available files...</p>
        </div>
    </section>
    
    <section class="stats">
        <h2>üìä How to Use</h2>
        <p><strong>Method 1:</strong> Download the YAML/JSON files and use with compatible applications.</p>
        <p><strong>Method 2:</strong> Use the direct URL in your IPTV player (if supported).</p>
        <p><strong>Method 3:</strong> Clone the repository and access the files locally.</p>
    </section>
    
    <footer>
        <p>üîó <a href="https://github.com/${{ github.repository }}">GitHub Repository</a> | 
           ‚öôÔ∏è <a href="https://github.com/${{ github.repository }}/actions">Workflow Status</a></p>
        <p>‚ö†Ô∏è These streams are collected from public sources. Use at your own risk.</p>
        <p>üîÑ Auto-generated by GitHub Actions</p>
    </footer>
    
    <script>
        // Load data from latest.yml
        fetch('https://raw.githubusercontent.com/${{ github.repository }}/main/auto_updated_playlists/latest.yml')
            .then(response => response.text())
            .then(text => {
                // Parse YAML (simple parsing for metadata)
                const lines = text.split('\n');
                let metadata = {};
                lines.forEach(line => {
                    if (line.includes('generated_at:')) {
                        const date = line.split('generated_at:')[1].trim();
                        document.getElementById('last-update').textContent = new Date(date).toLocaleString();
                    }
                    if (line.includes('total_channels:')) {
                        const count = line.split('total_channels:')[1].trim();
                        document.getElementById('total-channels').textContent = count;
                    }
                });
                
                // Calculate next update (5 minutes from last update)
                if (document.getElementById('last-update').textContent !== 'Loading...') {
                    const lastUpdate = new Date(document.getElementById('last-update').textContent);
                    const nextUpdate = new Date(lastUpdate.getTime() + 5 * 60000);
                    document.getElementById('next-update').textContent = nextUpdate.toLocaleString();
                }
            })
            .catch(error => console.error('Error loading data:', error));
        
        // List available files
        fetch('https://api.github.com/repos/${{ github.repository }}/contents/auto_updated_playlists')
            .then(response => response.json())
            .then(files => {
                const filesList = document.getElementById('files-list');
                filesList.innerHTML = '';
                
                files.forEach(file => {
                    if (file.name.endsWith('.yml') || file.name.endsWith('.json') || file.name === 'README.md') {
                        const fileCard = document.createElement('div');
                        fileCard.className = 'file-card';
                        
                        const fileType = file.name.endsWith('.yml') ? 'YAML' : 
                                        file.name.endsWith('.json') ? 'JSON' : 'Markdown';
                        const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                        
                        fileCard.innerHTML = `
                            <h3>${file.name}</h3>
                            <p><strong>Type:</strong> ${fileType}</p>
                            <p><strong>Size:</strong> ${fileSize}</p>
                            <a href="${file.download_url}" class="btn" download>Download</a>
                            ${file.name === 'latest.yml' ? '<span class="badge">Latest</span>' : ''}
                        `;
                        
                        filesList.appendChild(fileCard);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading files:', error);
                document.getElementById('files-list').innerHTML = '<p>Error loading files. Please check the repository.</p>';
            });
    </script>
</body>
</html>
EOF
    
    - name: Commit and push changes
      if: steps.update.outcome == 'success'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add auto_updated_playlists/ docs/
        
        if ! git diff --cached --quiet; then
          git commit -m "ü§ñ Auto-update playlists $(date -u +'%Y-%m-%d %H:%M UTC')
          
          Total channels: $(find auto_updated_playlists/latest.yml -exec grep -o 'total_channels: [0-9]*' {} \; | cut -d' ' -f2 || echo 'Unknown')
          Generated at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          git pull --rebase origin main
          git push origin main
          
          echo "‚úÖ Changes committed and pushed"
        else
          echo "‚úÖ No changes to commit"
        fi
    
    - name: Create workflow summary
      if: always()
      run: |
        echo "## üé¨ IPTV Playlist Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.update.outcome }}" == "success" ]; then
          echo "‚úÖ **Status:** Update completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Try to get channel count
          if [ -f "auto_updated_playlists/latest.yml" ]; then
            CHANNEL_COUNT=$(grep -o 'total_channels: [0-9]*' auto_updated_playlists/latest.yml | cut -d' ' -f2 || echo "Unknown")
            echo "**Total Channels:** $CHANNEL_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "**Files Generated:**" >> $GITHUB_STEP_SUMMARY
            echo "- `latest.yml` - Always contains latest playlist" >> $GITHUB_STEP_SUMMARY
            echo "- `playlist_*.yml` - Timestamped version" >> $GITHUB_STEP_SUMMARY
            echo "- `playlist_*.json` - JSON version" >> $GITHUB_STEP_SUMMARY
            echo "- `README.md` - Statistics and info" >> $GITHUB_STEP_SUMMARY
            echo "- `docs/index.html` - Web interface" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ùå **Status:** Update failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Update:** Scheduled in 5 minutes" >> $GITHUB_STEP_SUMMARY
        echo "**View Files:** [auto_updated_playlists/](https://github.com/${{ github.repository }}/tree/main/auto_updated_playlists)" >> $GITHUB_STEP_SUMMARY
